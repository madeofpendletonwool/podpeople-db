<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Podcast.Title}} - PodPeopleDB</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script>
        function handleImageError(img) {
            img.onerror = null;
            img.src = '/static/default-avatar.png';
        }
        function toggleEpisodes(id) {
            var episodeList = document.getElementById('episodes-' + id);
            if (episodeList.style.display === 'none') {
                episodeList.style.display = 'block';
            } else {
                episodeList.style.display = 'none';
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <img src="/static/podpeople.png" alt="PodPeopleDB Logo" class="logo">
        <h1>{{.Podcast.Title}}</h1>
        <img src="{{.Podcast.Image}}" alt="{{.Podcast.Title}} Artwork" class="podcast-image">
        <div class="podcast-info">
            <p><strong>Author:</strong> {{.Podcast.Author}}</p>
            <p><strong>Owner:</strong> {{.Podcast.OwnerName}}</p>
            <p><strong>Description:</strong> {{.Podcast.Description}}</p>
            <p><strong>Website:</strong> <a href="{{.Podcast.Link}}" target="_blank">{{.Podcast.Link}}</a></p>
            <p><strong>Feed URL:</strong> <a href="{{.Podcast.FeedURL}}" target="_blank">{{.Podcast.FeedURL}}</a></p>
        </div>        
        <h2>Hosts and Guests</h2>
        <div id="host-list">
            {{if .PersonTags}}
                <h3>Hosts</h3>
                {{range .Podcast.Hosts}}
                    {{if eq .Role "Host"}}
                        <div class="host-item">
                            <img src="{{.Img}}" alt="{{.Name}}" class="host-image" onerror="handleImageError(this)">
                            <div class="host-info">
                                <h3>{{.Name}}</h3>
                                <p><strong>Role:</strong> {{.Role}}</p>
                                {{if .Group}}<p><strong>Group:</strong> {{.Group}}</p>{{end}}
                                {{if .Href}}<a href="{{.Href}}" target="_blank">More Info</a>{{end}}
                                {{if .Episodes}}
                                    {{if gt (len .Episodes) 5}}
                                        <p><strong>Associated Episodes:</strong> <a href="#" onclick="toggleEpisodes('{{.Name}}'); return false;">Show/Hide ({{len .Episodes}} episodes)</a></p>
                                        <ul id="episodes-{{.Name}}" style="display: none;">
                                            {{range .Episodes}}
                                                <li>{{.}}</li>
                                            {{end}}
                                        </ul>
                                    {{else}}
                                        <p><strong>Associated Episodes:</strong></p>
                                        <ul>
                                            {{range .Episodes}}
                                                <li>{{.}}</li>
                                            {{end}}
                                        </ul>
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                    {{end}}
                {{end}}
                
                <h3>Guests</h3>
                {{range .Podcast.Hosts}}
                    {{if eq .Role "Guest"}}
                        <div class="host-item">
                            <img src="{{.Img}}" alt="{{.Name}}" class="host-image" onerror="handleImageError(this)">
                            <div class="host-info">
                                <h3>{{.Name}}</h3>
                                <p><strong>Role:</strong> {{.Role}}</p>
                                {{if .Group}}<p><strong>Group:</strong> {{.Group}}</p>{{end}}
                                {{if .Href}}<a href="{{.Href}}" target="_blank">More Info</a>{{end}}
                                {{if .Episodes}}
                                    {{if gt (len .Episodes) 5}}
                                        <p><strong>Associated Episodes:</strong> <a href="#" onclick="toggleEpisodes('{{.Name}}'); return false;">Show/Hide ({{len .Episodes}} episodes)</a></p>
                                        <ul id="episodes-{{.Name}}" style="display: none;">
                                            {{range .Episodes}}
                                                <li>{{.}}</li>
                                            {{end}}
                                        </ul>
                                    {{else}}
                                        <p><strong>Associated Episodes:</strong></p>
                                        <ul>
                                            {{range .Episodes}}
                                                <li>{{.}}</li>
                                            {{end}}
                                        </ul>
                                    {{end}}
                                {{end}}
                            </div>
                        </div>
                    {{end}}
                {{end}}
                {{else}}
                {{if .Hosts}}
                    <h3>Hosts</h3>
                    {{range .Hosts}}
                        {{if eq .Role "Host"}}
                            <div class="host-item" id="host-{{.ID}}">
                                <img src="{{if .Img}}{{.Img}}{{else}}/static/default-avatar.png{{end}}"
                                     alt="{{.Name}}"
                                     class="host-image"
                                     onerror="handleImageError(this)">
                                <div class="host-info">
                                    <h3>{{.Name}}</h3>
                                    <p><strong>Role:</strong> {{.Role}}</p>
                                    <p>{{.Description}}</p>
                                    <a href="{{.Link}}" target="_blank">More Info</a>
                                    {{if $.IsAdmin}}
                                        <button hx-delete="/delete-host/{{.ID}}"
                                                hx-target="#host-{{.ID}}"
                                                hx-swap="outerHTML"
                                                class="delete-host">Delete</button>
                                    {{end}}
                                </div>
                            </div>
                        {{end}}
                    {{end}}
                    
                    <h3>Guests</h3>
                    {{range .Hosts}}
                        {{if eq .Role "Guest"}}
                            <div class="host-item" id="host-{{.ID}}">
                                <img src="{{if .Img}}{{.Img}}{{else}}/static/default-avatar.png{{end}}"
                                     alt="{{.Name}}"
                                     class="host-image"
                                     onerror="handleImageError(this)">
                                <div class="host-info">
                                    <h3>{{.Name}}</h3>
                                    <p><strong>Role:</strong> {{.Role}}</p>
                                    <p>{{.Description}}</p>
                                    <a href="{{.Link}}" target="_blank">More Info</a>
                                    {{if $.IsAdmin}}
                                        <button hx-delete="/delete-host/{{.ID}}"
                                                hx-target="#host-{{.ID}}"
                                                hx-swap="outerHTML"
                                                class="delete-host">Delete</button>
                                    {{end}}
                                </div>
                            </div>
                        {{end}}
                    {{end}}
                {{else}}
                    <p>No hosts or guests found for this podcast.</p>
                {{end}}
 
                <div class="add-host-section">
                    <h2>Add New Host/Guest</h2>
                    <form hx-post="/add-host" hx-target="#pending-hosts" hx-swap="none">
                        <input type="hidden" name="podcastId" value="{{.Podcast.ID}}">
                        <input type="text" name="name" placeholder="Name" required>
                        <select name="role" required>
                            <option value="">Select Role</option>
                            <option value="Host">Host</option>
                            <option value="Guest">Guest</option>
                        </select>
                        <textarea name="description" placeholder="Description" required></textarea>
                        <input type="url" name="link" placeholder="Link (Wiki, Github, etc.)" required>
                        <input type="url" name="img" placeholder="Image URL (optional)">
                        <button type="submit">Add Host/Guest</button>
                    </form>
                </div>

                <div id="pending-hosts">
                    <!-- Newly submitted hosts will be added here -->
                </div>
            {{end}}
        </div>
    </div>

    <template id="pending-host-template">
        <div class="host-item pending-host">
            <span class="pending-label">Pending Approval</span>
            <img src="${img}" alt="${name}" class="host-image" onerror="handleImageError(this)">
            <div class="host-info">
                <h3>${name}</h3>
                <p><strong>Role:</strong> ${role}</p>
                <p>${description}</p>
                <a href="${link}" target="_blank">More Info</a>
            </div>
        </div>
    </template>

    <script>
        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.target.id === 'pending-hosts') {
                const template = document.getElementById('pending-host-template');
                const newHost = JSON.parse(event.detail.xhr.response);
                const pendingHost = document.createElement('div');
                pendingHost.innerHTML = template.innerHTML;
                
                pendingHost.querySelector('img').src = newHost.img || '/static/default-avatar.png';
                pendingHost.querySelector('h3').textContent = newHost.name;
                pendingHost.querySelector('p strong').nextSibling.textContent = ' ' + newHost.role;
                pendingHost.querySelector('p:nth-of-type(2)').textContent = newHost.description;
                pendingHost.querySelector('a').href = newHost.link;

                event.detail.target.appendChild(pendingHost.firstElementChild);
            }
        });
    </script>
</body>
</html>